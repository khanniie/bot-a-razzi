<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>baby</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="js/aframe-look-at.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    <style>
        #changecam{
            position: relative;
            display: none;
            background-color: black;
            color: white;
            width: 100%;
            height:100%;
        }
        p{
            position: absolute;
            left: 40%;
            top: 45%;
        }
    </style>
</head>

<body>
    <div id="changecam"><p>changing camera...</p></div>
    <audio id="sound" src="http://www.soundjay.com/button/beep-07.wav"></audio>
    <a-scene vr-mode-ui="enabled: false" id="babyscene">
        <a-assets>
            <a-asset-item id="bot-obj" src="models/better-eyeball.obj" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="bot-mtl" src="models/better-eyeball.mtl" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="eyeball-obj" src="models/better-eyeball.obj" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="eyeball-mtl" src="models/better-eyeball.mtl" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="hospital" src="models/hospital.dae" crossOrigin="anonymous"></a-asset-item>
<!--             <a-asset-item id="babyhead" src="models/baby_head.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="babybody" src="models/baby_body.dae" crossOrigin="anonymous"></a-asset-item> -->
            <a-asset-item id="skull-model" src="models/box.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="baby" src="models/baby.dae" crossOrigin="anonymous"></a-asset-item>
        </a-assets>
        <a-light type="point" color="white" position="0 5 0" intensity=".8"></a-light>
        <a-light type="ambient" color="white" position="0 5 0" intensity=".2"></a-light>
        <a-light type="ambient" color="#10A0B0" intensity=".5"></a-light>
        <a-collada-model src="#hospital" position="-.65 -2.1 -.47" rotation="0 90 0"></a-collada-model>
        <a-entity id="person" position="0 -1 -1" look-at="#bot-container">
            <a-collada-model position="0 0 0" src="#babyhead" scale=".4 .4 .4"> </a-collada-model>
        </a-entity>
    </a-scene>
    <!-- scripts! -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>
    <script src="js/Bot.js"></script>
    <script>
    //Initialize Firebase
    var config = {
        apiKey: "AIzaSyD8B8P-Bejr47q3FzLG7KO3EF-CvHp6028",
        authDomain: "bot-a-razzi.firebaseapp.com",
        databaseURL: "https://bot-a-razzi.firebaseio.com",
        projectId: "bot-a-razzi",
        storageBucket: "",
        messagingSenderId: "24375466887"
    };
    firebase.initializeApp(config);
    var database = firebase.database();

    //grab number of robots
    var numbots = 6
    database.ref('info/numbots').once('value', function(snapshot) {
        numbots = snapshot.val();
    });

    //initialize the bots
    var botarr = [];

    var head = document.querySelector('#person').object3D;

    // AFRAME.registerComponent('baby-body', {
    //     tick: function() {

    //         var el = this.el;
    //         var rot = head.rotation.y / 3.14 * 180;
    //         if( rot > -30 && rot <= 30){
    //             el.setAttribute('rotation', { x: 0, y: 0, z: 0 });
    //         }
    //         else if( rot > 30 && rot <= 60){
    //             el.setAttribute('rotation', { x: 0, y: 0, z: 0 });
    //         }
    //         else if( rot <= -30 && rot > -60){
    //             el.setAttribute('rotation', { x: 0, y: 90, z: 0 });
    //         }
    //         else if( rot > 60 && rot < 90){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else if( rot < -60 && rot > -90){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else if( rot < -90 && rot > -120){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else if( rot > 90 && rot < 120){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else if( rot < -120 && rot > -150){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else if( rot < -150 && rot > -180){
    //             el.setAttribute('rotation', { x: 0, y: -90, z: 0 });
    //         }
    //         else{
    //             el.setAttribute('rotation', { x: 0, y: 180, z: 0 });
    //         }
    //     }
    // });

//$('#babyscene').append("<a-collada-model baby-body src='#babybody' scale='.4 .4 .4' position='0 -2.85 -1'> </a-collada-model>");

AFRAME.registerComponent('bot', {
  schema: {
        src: {default: '#eyeball-obj'},
        mtl: {default: '#eyeball-mtl'}
  },
  init: function () {
    this.tick = AFRAME.utils.throttleTick(this.tick, 50, this);
    this.cam = document.getElementById("active-camera");
    this.id = this.el.id;
  },
  tick: function (t, dt) {
    var isCam = botarr[parseInt((this.id).slice(3, 4))].currentCamera;
    var el = this.el;
    database.ref('bots/' + this.id).once('value', function(snapshot) {
        el.setAttribute('position', {x: snapshot.val().x, y: snapshot.val().y, z: snapshot.val().z});
        el.setAttribute('rotation', {x: snapshot.val().rotx, y: snapshot.val().roty, z: snapshot.val().rotz});
        if(isCam){
             cam.setAttribute("position", { x: snapshot.val().x, y: snapshot.val().y, z: snapshot.val().z});
             cam.flushToDOM(); 
        }
        el.flushToDOM();
  });
  },
});

AFRAME.registerComponent('bot-container', {
  init: function () {
    this.tick = AFRAME.utils.throttleTick(this.tick, 50, this);
  },
  tick: function (t, dt) {
    var el = this.el;
    database.ref('bots/bot-container').once('value', function(snapshot) {
            if (snapshot.val() != null) {
            el.setAttribute('position', {x: snapshot.val().x, y: snapshot.val().y, z: snapshot.val().z});
            el.setAttribute('rotation', {x: snapshot.val().rotx, y: snapshot.val().roty, z: snapshot.val().rotz});
        }
    });
  },
});

    $('#babyscene').append("<a-entity id='bot-container' bot-container position='0 0 0' scale='1 1 1'><a-entity look-at='#person' camera id='active-camera' position='0 1.8 1'></a-entity> <a-light id='flash' type='point' color='#FFFFAA' visible='false'></a-light></a-entity>");

    var cam = document.getElementById("active-camera");
    
    // //checks that the bots exist, updates position if the other page is reinitialized
    database.ref('info/botsinitialized').on('value', function(snapshot) {
        $(".bot").remove();
        if (snapshot.val()) {
            botarr = [];
            for (var i = 0; i < numbots; i++) {
                botarr.push(new Bot(i));
                //updatebot(i);
            }
            //setup
            setInterval(changeCameraView, 30000);
            if(cam != null){
                changeCameraView();
            } 
        } else {
            console.log("the VR side hasn't started up yet!");
            var cam = document.getElementById("active-camera");
            cam.setAttribute("position", { x: 0, y: 0.5, z: 0.5 });
            cam.flushToDOM();
        }
    });
    var currentCamera = null;
    // //camera view changer
    var changeCameraView = function() {
        var randomnum = Math.floor(Math.random() * numbots);
        var randombot = document.getElementById("bot" + randomnum);

        botarr[randomnum].currentCamera = true;
        if (currentCamera != null) {
            currentCamera.obj.setAttribute("visible", true);
            currentCamera.currentCamera = false;
        }
        currentCamera = botarr[randomnum];
        currentCamera.obj.setAttribute("visible", false);
        currentCamera.obj.flushToDOM();

        var pos = randombot.getAttribute('position');
        var cam = document.getElementById("active-camera");
        $("#changecam").css("display", "block");
        setTimeout(function(){
            $("#changecam").css("display", "none");
        }, 600);
        cam.setAttribute("position", { x: pos.x, y: pos.y, z: pos.z });
        cam.flushToDOM();
    }

    var flash = function() {
        var el = document.querySelector("#flash");
        el.setAttribute("visible", true);
        document.getElementById("sound").play();
        setTimeout(function() {
            el.setAttribute("visible", false);
        }, 200)
    }

    //toggling visibility 
    document.body.onkeyup = function(e) {
        if (e.keyCode == 37) {
            var el = document.querySelector("#babyscene");
            el.setAttribute("visible", false);
        }
        if (e.keyCode == 39) {
            var el = document.querySelector("#babyscene");
            el.setAttribute("visible", true);
        }
        if (e.keyCode == 32) {

            console.log(document.querySelector("#person").object3D.rotation);
        }
        if (e.keyCode == 65) {
            flash();
        }
        if (e.keyCode == 66) {
            var r = document.getElementById("person").getAttribute("rotation");
            console.log(r);
        }
    }
    </script>
</body>

</html>