<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>baby</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="js/aframe-look-at.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    <style>
        #changecam {
            position: relative;
            display: none;
            background-color: black;
            color: white;
            width: 100%;
            height: 100%;
        }
        p {
            position: absolute;
            left: 40%;
            top: 45%;
        }
    </style>
</head>

<body>
    <div id="changecam">
        <p>changing camera...</p>
    </div>
    <audio id="sound" src="http://www.soundjay.com/button/beep-07.wav"></audio>
    <a-scene vr-mode-ui="enabled: false" id="babyscene">
        <a-assets>
            <a-asset-item id="chair" src="bedroom-models/chair-textured.dae"></a-asset-item>
            <a-asset-item id="desk" src="bedroom-models/desk-colored.dae"></a-asset-item>
            <a-asset-item id="bed" src="bedroom-models/colored-bed-2.dae"></a-asset-item>
            <a-asset-item id="carpet" src="bedroom-models/blue-carpet.jpg"></a-asset-item>
            <a-asset-item id="guy" src="bedroom-models/guy-poster.jpg"></a-asset-item>
            <a-asset-item id="grillbabygrill" src="bedroom-models/grillbabygrill.jpg"></a-asset-item>
            <a-asset-item id="free-poster" src="bedroom-models/free-poster.jpeg"></a-asset-item>
            <a-asset-item id="gakkuen" src="bedroom-models/yuri%20on%20gakkuen.jpg"></a-asset-item>
            <a-asset-item id="free-poster" src="bedroom-models/free-poster.jpeg"></a-asset-item>
            <a-asset-item id="hetalia" src="bedroom-models/hetalia.png"></a-asset-item>
            <a-asset-item id="legend" src="bedroom-models/legend%20of%20sexy.jpg"></a-asset-item>
            <a-asset-item id="toilet" src="bathroom-models/toilet.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="trashcan" src="bathroom-models/trashcan.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="sink" src="bathroom-models/sink.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tp" src="bathroom-models/tp.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="door" src="bathroom-models/door.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tv" src="bathroom-models/tv.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tile" src="bathroom-models/tile.jpg" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="bot-obj" src="models/better-eyeball.obj" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="bot-mtl" src="models/better-eyeball.mtl" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="hospital" src="models/hospital.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="babyhead" src="models/baby_head.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="babybody" src="models/baby_body.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="baby" src="models/baby.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="bot-dae" src="models/cameraball.dae" crossOrigin="anonymous"></a-asset-item>
        </a-assets>
      
        <a-entity id="scene0" visible="true" scale=".5 .5 .5">
            <a-light type="ambient" color="#44F" intensity=".5"></a-light>
            <a-light type="ambient" color="white" intensity=".3"></a-light>
            <a-light type="point" color="white" position="0 5 0" intensity=".8"></a-light>

            <a-collada-model src="#hospital" position="-.65 -2.1 -.47" rotation="0 90 0"></a-collada-model>
            <a-plane color="#333" segments-height="0.05" segments-width="0.05" scale="15 15 4" position="1.5 -5 0" rotation="-90 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="-6 -1 0" rotation="0 90 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="9 -1 0" rotation="0 -90 0"></a-plane>
            <a-plane color="#F88" scale="15 15 1" position="1.5 3 0" rotation="90 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="1.5 -1 -7.5" rotation="0 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="1.5 -1 7" rotation="0 180 0"></a-plane>

        </a-entity>

        <a-entity id="scene1" visible="false">

            <a-collada-model src="#chair" position="0.95 0 -1.3" rotation="0 -90 0" scale="0.5 0.5 0.5"></a-collada-model>
            <a-collada-model src="#desk" position="0.75 0 -1.5" rotation="0 180 0" scale="1 1 1"></a-collada-model>
            <a-collada-model src="#bed" position="-1.2 0.4 -0.3" rotation="0 180 0" scale="1 1 1"></a-collada-model>
            <a-light type="directional" position="0 4 0" color="#EF0" intensity="0.5"></a-light>
            <a-light type="ambient" color="#FFF" intensity="0.5"></a-light>
            <a-plane src="#carpet" segments-height="0.05" segments-width="0.05" scale="3.5 5 4" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-plane color="#EEE" scale="5 4 4" position="-1.75 2 0" rotation="0 90 0"></a-plane>
            <a-plane color="#EEE" scale="5 4 4" position="1.75 2 0" rotation="0 -90 0"></a-plane>
            <a-plane color="#EEE" scale="4 5 4" position="0 4 0" rotation="90 0 0"></a-plane>
            <a-plane color="#EEE" scale="4 4 4" position="0 2 -2.5" rotation="0 0 0"></a-plane>
            <a-plane color="#EEE" scale="4 4 4" position="0 2 2.5" rotation="0 180 0"></a-plane>
            <a-plane src="#guy" scale="0.5 0.75 1" position="1.738 1.75 -1" rotation="0 -90 0"></a-plane>
            <a-plane src="#free-poster" scale="0.5 0.6 1" position="1 1.75 -2.49" rotation="0 0 0"></a-plane>
            <a-plane src="#grillbabygrill" scale="0.3 0.4 1" position="0.4 1.5 -2.49" rotation="0 0 0"></a-plane>
            <a-plane src="#gakkuen" scale="0.5 .35 1" position="0.3 2 -2.49" rotation="0 0 0"></a-plane>
            <a-plane src="#hetalia" scale="0.8 0.6 1" position="1.739 1.5 -1.8" rotation="0 -90 0"></a-plane>
            <a-plane src="#legend" scale="1 0.8 1" position="1.74 2.3 -1.6" rotation="0 -90 0"></a-plane>
        </a-entity>

        <a-entity id="scene2" visible="false">

            <a-light type="ambient" color="#FEF" intensity=".7"></a-light>
            <a-light type="point" color="white" position="0 5 0" intensity=".5"></a-light>
            <a-plane shadow="receive: true" material="src: #tile; repeat:10 10" scale="5 5 5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-plane color="#EEA" scale="5 4 4" position="-1.75 2 0" rotation="0 90 0"></a-plane>
            <a-plane color="#EEA" scale="5 4 4" position="1.75 2 0" rotation="0 -90 0"></a-plane>
            <a-plane color="#EEA" scale="4 5 4" position="0 4 0" rotation="90 0 0"></a-plane>
            <a-plane color="#EEA" scale="4 4 4" position="0 2 -1.5" rotation="0 0 0"></a-plane>
            <a-plane color="#EEA" scale="4 4 4" position="0 2 1.5" rotation="0 180 0"></a-plane>
            <a-box position="-2 1.6 -1" rotation="0 0 0" scale=".01 .01 .01" color="#4CC3D9" shadow></a-box>
            <a-collada-model src="#sink" scale=".25 .25 .25" position="1 0 .1" rotation="0 180 0"></a-collada-model>
            <a-collada-model src="#toilet" scale=".18 .18 .18" position="-.4 .2 .2"></a-collada-model>
            <a-collada-model src="#door" scale=".25 .25 .25" position="-1.7 -.15 -1"></a-collada-model>
            <a-collada-model src="#trashcan" scale=".18 .18 .18" position=".8 .2 .2"></a-collada-model>
            <a-collada-model src="#tp" scale=".1 .1 .1" position="-.8 0 1"></a-collada-model>
            <a-collada-model src="#tv" scale=".3 .3 .3" position="-.2 1 -2.7"></a-collada-model>
        </a-entity>

        <a-entity id="person" position="0 -1 -1" look-at="#bot-container">
            <a-collada-model position="0 0 0" src="#babyhead" scale=".4 .4 .4"> </a-collada-model>
        </a-entity>
      
      
      
    </a-scene>
    <!-- scripts! -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>
    <script src="js/Bot.js"></script>
    <script>
        //Initialize Firebase
        var config = {
            apiKey: "AIzaSyD8B8P-Bejr47q3FzLG7KO3EF-CvHp6028",
            authDomain: "bot-a-razzi.firebaseapp.com",
            databaseURL: "https://bot-a-razzi.firebaseio.com",
            projectId: "bot-a-razzi",
            storageBucket: "",
            messagingSenderId: "24375466887"
        };
        firebase.initializeApp(config);
        var database = firebase.database();
        var currentScene = 0;
        document.body.onkeyup = function(e) {
            if (e.keyCode == 32) {
                document.querySelector('#scene' + currentScene).setAttribute("visible", false);
                currentScene = (currentScene + 1) % 3;
                document.querySelector('#scene' + currentScene).setAttribute("visible", true);
                database.ref('scene').set({
                   x: currentScene,
                });
            }
             if (e.keyCode == 65) {
                database.ref('flash').set({
                   flash: 1,
                });
               flash(); 
            }
        }
        var flash = function() {
            var el = document.querySelector("#flash");
            el.setAttribute("visible", true);
            document.getElementById("sound").play();
            setTimeout(function() {
                el.setAttribute("visible", false);
            }, 200)
        }
        
        //grab number of robots
        var numbots = 6
        database.ref('info/numbots').once('value', function(snapshot) {
            numbots = snapshot.val();
        });
        //initialize the bots
        var botarr = [];
        var head = document.querySelector('#person').object3D;
        AFRAME.registerComponent('baby-body', {
            tick: function() {
                var el = this.el;
                var rot = head.rotation.y / 3.14 * 180;
                el.setAttribute('rotation', {
                    x: 0,
                    y: rot,
                    z: 0
                });
            }
        });
        $('#babyscene').append("<a-collada-model baby-body src='#babybody' scale='.4 .4 .4' position='0 -2.85 -1'> </a-collada-model>");
        AFRAME.registerComponent('bot', {
            schema: {
                src: {
                    default: '#eyeball-obj'
                },
                mtl: {
                    default: '#eyeball-mtl'
                }
            },
            init: function() {
                this.tick = AFRAME.utils.throttleTick(this.tick, 50, this);
                this.cam = document.getElementById("active-camera");
                this.id = this.el.id;
            },
            tick: function(t, dt) {
                var isCam = botarr[parseInt((this.id).slice(3, 4))].currentCamera;
                var el = this.el;
                database.ref('bots/' + this.id).once('value', function(snapshot) {
                    el.setAttribute('position', {
                        x: snapshot.val().x,
                        y: snapshot.val().y,
                        z: snapshot.val().z
                    });
                    el.setAttribute('rotation', {
                        x: snapshot.val().rotx,
                        y: snapshot.val().roty,
                        z: snapshot.val().rotz
                    });
                    if (isCam) {
                        cam.setAttribute("position", {
                            x: snapshot.val().x,
                            y: snapshot.val().y,
                            z: snapshot.val().z
                        });
                        cam.flushToDOM();
                    }
                    el.flushToDOM();
                });
            },
        });
        AFRAME.registerComponent('bot-container', {
            init: function() {
                this.tick = AFRAME.utils.throttleTick(this.tick, 50, this);
            },
            tick: function(t, dt) {
                var el = this.el;
                database.ref('bots/bot-container').once('value', function(snapshot) {
                    if (snapshot.val() != null) {
                        el.setAttribute('position', {
                            x: snapshot.val().x,
                            y: snapshot.val().y,
                            z: snapshot.val().z
                        });
                        el.setAttribute('rotation', {
                            x: snapshot.val().rotx,
                            y: snapshot.val().roty,
                            z: snapshot.val().rotz
                        });
                    }
                });
            },
        });
        $('#babyscene').append("<a-entity id='bot-container' bot-container position='0 0 0' scale='1 1 1'><a-entity look-at='#person' camera id='active-camera' position='0 1.8 1'></a-entity> <a-light id='flash' type='point' color='#FFFFAA' visible='false'></a-light></a-entity>");
        var cam = document.getElementById("active-camera");
        // //checks that the bots exist, updates position if the other page is reinitialized
        database.ref('info/botsinitialized').on('value', function(snapshot) {
            $(".bot").remove();
            if (snapshot.val()) {
                botarr = [];
                for (var i = 0; i < numbots; i++) {
                    botarr.push(new Bot(i));
                    //updatebot(i);
                }
                //setup
                setInterval(changeCameraView, 20000);
                if (cam != null) {
                    changeCameraView();
                }
            } else {
                console.log("the VR side hasn't started up yet!");
                var cam = document.getElementById("active-camera");
                cam.setAttribute("position", {
                    x: 0,
                    y: 0.5,
                    z: 0.5
                });
                cam.flushToDOM();
            }
        });
        var currentCamera = null;
        // //camera view changer
        var changeCameraView = function() {
            var randomnum = Math.floor(Math.random() * numbots);
            var randombot = document.getElementById("bot" + randomnum);
            botarr[randomnum].currentCamera = true;
            if (currentCamera != null) {
                currentCamera.obj.setAttribute("visible", true);
                currentCamera.currentCamera = false;
            }
            currentCamera = botarr[randomnum];
            currentCamera.obj.setAttribute("visible", false);
            currentCamera.obj.flushToDOM();
            var pos = randombot.getAttribute('position');
            var cam = document.getElementById("active-camera");
            $("#changecam").css("display", "block");
            setTimeout(function() {
                $("#changecam").css("display", "none");
            }, 600);
            cam.setAttribute("position", {
                x: pos.x,
                y: pos.y,
                z: pos.z
            });
            cam.flushToDOM();
        }
    </script>
</body>

</html>