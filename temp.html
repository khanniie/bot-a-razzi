<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>baby</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script>
    <script src="js/aframe-look-at.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
    <style>
        #changecam {
            position: relative;
            display: none;
            background-color: black;
            color: white;
            width: 100%;
            height: 100%;
        }
        p {
            position: absolute;
            left: 40%;
            top: 45%;
        }
    </style>
</head>

<body>
    <div id="changecam">
        <p>changing camera...</p>
    </div>
      <audio id="sound" src="sound/sound1.mp3"></audio>
    <a-scene vr-mode-ui="enabled: false" id="babyscene">
        <a-assets>
          <a-asset-item id="sky" src="bedroom-models/gradient-sky.jpg"></a-asset-item>
          <a-asset-item id="door" src="bedroom-models/door.dae"></a-asset-item>
          <a-asset-item id="chair" src="bedroom-models/chair-textured.dae"></a-asset-item>
          <a-asset-item id="desk" src="bedroom-models/desk-colored.dae"></a-asset-item>
          <a-asset-item id="dresser" src="bedroom-models/dresser.dae"></a-asset-item>
          <a-asset-item id="bed" src="bedroom-models/colored-bed-2.dae"></a-asset-item>
          <a-asset-item id="bottles" src="bedroom-models/bottles.dae"></a-asset-item>
          <a-asset-item id="window" src="bedroom-models/windowframe.dae"></a-asset-item>
          <a-asset-item id="lamp-object" src="bedroom-models/lamp-object-only.dae"></a-asset-item>
          <a-asset-item id="carpet" src="bedroom-models/blue-carpet.jpg"></a-asset-item>
          <a-asset-item id="guy" src="bedroom-models/guy-poster.jpg"></a-asset-item>
          <a-asset-item id="grillbabygrill" src="bedroom-models/grillbabygrill.jpg"></a-asset-item>
          <a-asset-item id="free-poster" src="bedroom-models/free-poster.jpeg"></a-asset-item>
          <a-asset-item id="gakkuen" src="bedroom-models/yuri%20on%20gakkuen.jpg"></a-asset-item>
          <a-asset-item id="free-poster" src="bedroom-models/free-poster.jpeg"></a-asset-item>
          <a-asset-item id="hetalia" src="bedroom-models/hetalia.png"></a-asset-item>
          <a-asset-item id="sasunaru" src="bedroom-models/sasunaru.png"></a-asset-item>
          <a-asset-item id="legend" src="bedroom-models/legend%20of%20sexy.jpg"></a-asset-item>
            <a-asset-item id="toilet" src="bathroom-models/toilet.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="trashcan" src="bathroom-models/trashcan.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="sink" src="bathroom-models/sink.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tp" src="bathroom-models/tp.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="door" src="bathroom-models/door.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tv" src="bathroom-models/tv.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="tile" src="bathroom-models/tile.jpg" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="hospital" src="models/hospital.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="babyhead" src="models/baby_head.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="babybody" src="models/baby_body.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="baby" src="models/baby.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="mom" src="bathroom-models/mom-with-origin.dae" crossOrigin="anonymous"></a-asset-item>
            <a-asset-item id="weeb" src="bedroom-models/good-weeb.dae" crossOrigin="anonymous"></a-asset-item>
          
            <a-asset-item id="bot-dae" src="models/cameraball.dae" crossOrigin="anonymous"></a-asset-item>
        </a-assets>
      
        <a-entity id="scene0" visible="true" scale=".5 .5 .5" position="0 2 0">
            <a-light type="ambient" color="#44F" intensity=".5"></a-light>
            <a-light type="ambient" color="white" intensity=".3"></a-light>
            <a-light type="point" color="white" position="0 5 0" intensity=".8"></a-light>

            <a-collada-model src="#hospital" position="-.65 -2.1 -.47" rotation="0 90 0"></a-collada-model>
            <a-plane color="#333" segments-height="0.05" segments-width="0.05" scale="15 15 4" position="1.5 -5 0" rotation="-90 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="-6 -1 0" rotation="0 90 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="9 -1 0" rotation="0 -90 0"></a-plane>
            <a-plane color="#F88" scale="15 15 1" position="1.5 3 0" rotation="90 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="1.5 -1 -7.5" rotation="0 0 0"></a-plane>
            <a-plane color="#F88" scale="15 8 1" position="1.5 -1 7" rotation="0 180 0"></a-plane>

        </a-entity>

        <a-entity id="scene1" visible="false">

            <a-collada-model src="#door" position="-0.452 -0.125 2.4" rotation="0 90 0" scale="0.3 0.35 0.3"></a-collada-model>
          <a-collada-model src="#chair" position="0.95 0 -1.3" rotation="0 -90 0" scale="0.5 0.5 0.5"></a-collada-model>
          <a-collada-model src="#desk" position="0.75 0.148 -1.5" rotation="0 180 0" scale="1 1 1"></a-collada-model>
          <a-collada-model src="#dresser" position="-0.716 0.198 1.51" rotation="0 0 0" scale="0.8 0.8 0.8"></a-collada-model>
          <a-collada-model src="#bed" position="-1.35 0.3 -0.3" rotation="0 180 0" scale="1.05 1.09 1.03"></a-collada-model>
          <a-collada-model src="#bottles" position="-1.2 0.341 -0.3" rotation="0 180 0" scale="1 1 1"></a-collada-model>
          <a-collada-model src="#window" position="0.958 1.197 -1.873" rotation="0 270 0" scale="0.54 0.7 0.7"></a-collada-model>
          <a-collada-model src="#lamp-object" position="-0.037 3.541 -0.105" rotation="0 0 0" scale="0.5 0.5 0.5"></a-collada-model>
          <a-light type="point" position="-0.043 3.491 -0.103" color="#E3CFA3" intensity="0.5"></a-light>
          <!--
          <a-light type="point" position="1.21 1.596 -2.134" color="#FFFDEF" intensity="0.2"></a-light>-->
          <a-light type="ambient" color="#FFF" intensity="0.5"></a-light>
          <a-plane src="#carpet" segments-height="0.05" segments-width="0.05" scale="3.5 5 4" position="0 0 0" rotation="-90 0 0"></a-plane>
         
          <a-plane color="#EEE" scale="5 4 4" position="-1.75 2 0" rotation="0 90 0"></a-plane>
          <a-plane color="#EEE" scale="5 4 4" position="1.75 2 0" rotation="0 -90 0"></a-plane>
          <a-plane color="#EEE" scale="4 5 4" position="0 4 0" rotation="90 0 0"></a-plane>
          <a-plane color="#EEE" scale="0.5 4 4" position="-1.559 2 -2.5" rotation="0 0 0"></a-plane>
          <a-plane color="#EEE" scale="0.5 4 4" position="1.55 2 -2.5" rotation="0 0 0"></a-plane>
          <a-plane color="#EEE" scale="4 1.3 4" position="0.2 3.38 -2.5" rotation="0 0 0"></a-plane>
          <a-plane color="#EEE" scale="4 1.39 4" position="0.2 0.68 -2.5" rotation="0 0 0"></a-plane>
          <a-plane color="#EEE" scale="4 4 4" position="0 2 2.5" rotation="0 180 0"></a-plane>

           <a-plane src="#sasunaru" scale="0.5 0.75 1" position="1.7 2.6 0.2" rotation="0 -90 0"></a-plane>
           <a-plane src="#guy" scale="0.5 0.75 1" position="1.738 1.75 -1" rotation="0 -90 0"></a-plane>
           <a-plane src="#free-poster" scale="0.5 0.6 1" position="1.749 2.228 -0.384" rotation="0 270 0"></a-plane>
           <a-plane src="#grillbabygrill" scale="0.3 0.4 1" position="1.734 1.62 -0.529" rotation="0 270 0"></a-plane>
           <a-plane src="#gakkuen" scale="0.5 .35 1" position="1.719 2 0.239" rotation="0 270 0"></a-plane>
           <a-plane src="#hetalia" scale="0.8 0.6 1" position="1.739 1.5 -1.8" rotation="0 -90 0"></a-plane>
           <a-plane src="#legend" scale="1 0.8 1" position="1.74 2.3 -1.6" rotation="0 -90 0"></a-plane>
           <a-sky src="#sky"></a-sky>
        </a-entity>

        <a-entity id="scene2" visible="false">

            <a-light type="ambient" color="#FEF" intensity=".7"></a-light>
            <a-light type="point" color="white" position="0 5 0" intensity=".5"></a-light>
            <a-plane shadow="receive: true" material="src: #tile; repeat:10 10" scale="5 5 5" position="0 0 0" rotation="-90 0 0"></a-plane>
            <a-plane color="#EEA" scale="5 4 4" position="-2 2 0" rotation="0 90 0"></a-plane>
            <a-plane color="#EEA" scale="5 4 4" position="2 2 0" rotation="0 -90 0"></a-plane>
            <a-plane color="#EEA" scale="4 5 4" position="0 4 0" rotation="90 0 0"></a-plane>
            <a-plane color="#EEA" scale="4 4 4" position="0 2 -2.5" rotation="0 0 0"></a-plane>
            <a-plane color="#EEA" scale="4 4 4" position="0 2 2.5" rotation="0 180 0"></a-plane>
            <a-plane id="yoga" src="images/yoga.mp4" scale="2.36 1.26 1" position="-.18 1.83 -2.44" rotation="0 0 0"></a-plane>
            <a-collada-model src="#sink" scale=".35 .35 .35" position="1 0 .1" rotation="0 180 0"></a-collada-model>
            <a-collada-model src="#toilet" scale=".3 .3 .3" position="-.4 .2 .2"></a-collada-model>
            <a-collada-model src="#door" scale=".4 .4 .4" position="-1.9 -.15 -1"></a-collada-model>
            <a-collada-model src="#trashcan" scale=".3 .3 .3" position="1.5 .2 .2"></a-collada-model>
            <a-collada-model src="#tp" scale=".15 .15 .15" position="-.8 0 1"></a-collada-model>
            <a-collada-model src="#tv" scale=".5 .5 .5" position="0 1 -4.5"></a-collada-model>
        </a-entity>

<!--
        <a-entity id="person" position="0 -1 0" look-at="#bot-container">
            <a-collada-model position="0 0 0" src="#babyhead" scale=".4 .4 .4"> </a-collada-model>
        </a-entity>
      
-->
      
      <a-entity id="personlookat" look-at="#bot-container"> </a-entity>
      <a-collada-model turns id="person" src="#baby" scale=".2 .2 .2" position="0 .5 0" visible="false"> </a-collada-model>
      <a-collada-model turns id="person1" src="#weeb"  position="0.25 1.8 0" rotation="90 0 0" scale="1.5 1.5 1.5" visible="false"> </a-collada-model>
      <a-collada-model turns id="person2" src="#mom" position="0 2.147 0" visible="false" scale="1.6 1.6 1.6"> </a-collada-model>

      
    </a-scene>
    <!-- scripts! -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>
    <script src="js/Bot.js"></script>
    <script>
        //Initialize Firebase
        var config = {
            apiKey: "AIzaSyD8B8P-Bejr47q3FzLG7KO3EF-CvHp6028",
            authDomain: "bot-a-razzi.firebaseapp.com",
            databaseURL: "https://bot-a-razzi.firebaseio.com",
            projectId: "bot-a-razzi",
            storageBucket: "",
            messagingSenderId: "24375466887"
        };
        firebase.initializeApp(config);
        var database = firebase.database();
        var currentScene = 0;
        database.ref('scene').on('value', function(snapshot) {
            changeScene(snapshot.val().x); 
        }); 
        document.body.onkeyup = function(e) {
            if (e.keyCode == 32) {
              changeScene(currentScene + 1); 
            }
             if (e.keyCode == 65) {
                database.ref('flash').set({
                   flash: 1,
                });
               flash(); 
            }
        }
        
        var changeScene = function(x) {
              document.querySelector('#scene' + currentScene).setAttribute("visible", false);
              document.querySelector('#person').setAttribute("visible", false);
              document.querySelector('#person').setAttribute("id", "person" + currentScene);
              currentScene = x % 3;
              document.querySelector('#scene' + currentScene).setAttribute("visible", true);
              document.querySelector('#person'+ currentScene).setAttribute("visible", true);
              document.querySelector('#person'+ currentScene).setAttribute("id", "person");
              database.ref('scene').set({
                 x: currentScene,
              if(currentScene == 2) {
              document.querySelector("#yoga").setAttribute("src", "images/yoga.mp4"); 
            }
            else {
              document.querySelector("#yoga").setAttribute("src", ""); 

            }

                
              });
//              if (currentScene == 0)
//                  document.querySelector("#person").setAttribute("src", "#baby");
//              else if (currentScene == 1)
//                  document.querySelector("#person").setAttribute("position", "#weeb");
//              if (currentScene == 2)
//                  document.querySelector("#person").setAttribute("position", "#mom");
        }
        
        
        var flash = function() {
            var el = document.querySelector("#flash");
            el.setAttribute("visible", true);
            // document.getElementById("sound").play();
            setTimeout(function() {
                el.setAttribute("visible", false);
            }, 200)
        }
        
        // database.ref('flash').on('value', function(snapshot) {
        // flash(); 
        // }); 
        //grab number of robots
        var numbots = 6
        database.ref('info/numbots').once('value', function(snapshot) {
            numbots = snapshot.val();
        });
        //initialize the bots
        var botarr = [];
        var timer;
        var head = document.querySelector('#personlookat').object3D;
        AFRAME.registerComponent('turns', {
            tick: function() {
                var el = this.el;
                var rot = head.rotation.y / 3.14 * 180;
                el.setAttribute('rotation', {
                    x: 0,
                    y: rot,
                    z: 0
                });
            }
        });
 
        AFRAME.registerComponent('bot', {
            schema: {
                src: {
                    default: '#bot-dae'
                },
            },
            init: function() {
                this.tick = AFRAME.utils.throttleTick(this.tick, 200, this);
                this.cam = document.getElementById("active-camera");
                this.id = this.el.id;
            },
            tick: function(t, dt) {
                var isCam = botarr[parseInt((this.id).slice(3, 4))].currentCamera;
                var el = this.el;
                //console.log(this.id);
                database.ref('bots/' + this.id).once('value', function(snapshot) {
                    if(snapshot!=null){
                        el.setAttribute('position', {
                        x: snapshot.val().x,
                        y: snapshot.val().y,
                        z: snapshot.val().z
                    });
                    el.setAttribute('rotation', {
                        x: snapshot.val().rotx,
                        y: snapshot.val().roty,
                        z: snapshot.val().rotz
                    });
                    if (isCam) {
                        cam.setAttribute("position", {
                            x: snapshot.val().x,
                            y: snapshot.val().y,
                            z: snapshot.val().z
                        });
                        cam.flushToDOM();
                    }
                    el.flushToDOM();
                    }
                    
                });
            },
        });
        AFRAME.registerComponent('bot-container', {
            init: function() {
                this.tick = AFRAME.utils.throttleTick(this.tick, 200, this);
            },
            tick: function(t, dt) {
                var el = this.el;
                database.ref('bots/bot-container').once('value', function(snapshot) {
                    if (snapshot.val() != null) {
                        el.setAttribute('position', {
                            x: snapshot.val().x,
                            y: snapshot.val().y,
                            z: snapshot.val().z
                        });
                        el.setAttribute('rotation', {
                            x: snapshot.val().rotx,
                            y: snapshot.val().roty,
                            z: snapshot.val().rotz
                        });
                    }
                });
            },
        });
        $('#babyscene').append("<a-entity id='bot-container' bot-container position='0 0 0' scale='0.5 0.5 0.5'><a-entity look-at='#person' camera id='active-camera' position='0 1.8 1'></a-entity> <a-light id='flash' type='point' color='#FFFFAA' visible='false'></a-light></a-entity>");
        var cam = document.getElementById("active-camera");
        // //checks that the bots exist, updates position if the other page is reinitialized
        database.ref('info/botsinitialized').on('value', function(snapshot) {
            console.log($('.bot'));
            $(".bot").remove();
            if (snapshot.val()) {
                botarr = [];
                for (var i = 0; i < numbots; i++) {
                    botarr.push(new Bot(i));
                    //updatebot(i);
                }
                //setup
                // timer = setInterval(changeCameraView, 20000);
                // if (cam != null) {
                    setTimeout(changeCameraView, 700);
                //}
            } else {
                clearInterval(timer);
                currentCamera= null;
                console.log("the VR side hasn't started up yet!");
                var cam = document.getElementById("active-camera");
                cam.setAttribute("position", {
                    x: 0,
                    y: 0.5,
                    z: 0.5
                });
                cam.flushToDOM();
            }
        });
        var currentCamera = null;
        // //camera view changer
        var changeCameraView = function() {
            var randomnum = Math.floor(Math.random() * numbots);
            var randombot = document.getElementById("bot" + randomnum);
            botarr[randomnum].currentCamera = true;
            if (currentCamera != null) {
                currentCamera.obj.setAttribute("visible", true);
                currentCamera.currentCamera = false;
            }
            currentCamera = botarr[randomnum];
            currentCamera.obj.setAttribute("visible", false);
            currentCamera.obj.flushToDOM();
            var pos = randombot.getAttribute('position');
            var cam = document.getElementById("active-camera");
            // $("#changecam").css("display", "block");
            // setTimeout(function() {
            //     $("#changecam").css("display", "none");
            // }, 600);
            cam.setAttribute("position", {
                x: pos.x,
                y: pos.y,
                z: pos.z
            });
            cam.flushToDOM();
        }
    </script>
</body>

</html>